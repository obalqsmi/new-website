{% render "ysa-header" %}
{% render "ysa-theme" %}

<section class="cart">
  {% if cart.item_count == 0 %}
    <div class="cart__empty">
      <p>Your cart is empty.</p>
      <a href="/" class="btn">Continue Shopping</a>
      <a href="/products/all" class="btn btn--secondary">Browse All Products</a>
    </div>
  {% else %}
    <form action="/cart" method="post" novalidate class="cart__form">
      <table class="cart__table">
        <thead>
          <tr>
            <th scope="col">Product</th>
            <th scope="col">Price</th>
            <th scope="col">Quantity</th>
            <th scope="col">Subtotal</th>
            <th scope="col" class="visually-hidden">Remove</th>
          </tr>
        </thead>
        <tbody>
          {% for item in cart.items %}
          <tr data-line="{{ forloop.index }}">
            <td class="cart__product">
              <a href="{{ item.url }}" class="cart__image">{{ item.image | img_url: '200x200', crop: 'center' | img_tag: item.title }}</a>
              <div class="cart__info">
                <a href="{{ item.url }}" class="cart__title">{{ item.product.title }}</a>
                {% unless item.product.has_only_default_variant %}
                  <div class="cart__variant">{{ item.variant.title }}</div>
                {% endunless %}
              </div>
            </td>
            <td class="cart__price" data-label="Price">{{ item.price | money }}</td>
            <td class="cart__qty" data-label="Quantity">
              <button type="button" class="qty-btn" data-change="-1" aria-label="Decrease quantity">−</button>
              <label class="visually-hidden" for="updates_{{ item.key }}">Quantity</label>
              <input id="updates_{{ item.key }}" class="qty" name="updates[{{ item.key }}]" value="{{ item.quantity }}" type="number" min="0">
              <button type="button" class="qty-btn" data-change="1" aria-label="Increase quantity">+</button>
            </td>
            <td class="cart__subtotal" data-label="Subtotal">{{ item.line_price | money }}</td>
            <td class="cart__remove-cell" data-label="Remove"><button type="submit" class="cart__remove" name="updates[{{ item.key }}]" value="0" aria-label="Remove {{ item.title }}">×</button></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="cart__summary">
        <div class="cart__note">
          <label for="CartNote">Order note</label>
          <textarea id="CartNote" name="note" rows="3">{{ cart.note }}</textarea>
        </div>
        {% if settings.cart_discount_enable %}
        <div class="cart__discount">
          <label for="Discount">Promo code</label>
          <input id="Discount" type="text" name="discount" form="cart" autocomplete="off">
        </div>
        {% endif %}
        <p class="cart__subtotal-line">Subtotal <span id="CartSubtotal">{{ cart.total_price | money }}</span></p>
        <p class="cart__shipping">Taxes and shipping calculated at checkout.</p>
        <button type="submit" name="update" class="btn">Update Cart</button>
        <a href="/" class="btn btn--secondary">Continue Shopping</a>
        <button type="submit" name="checkout" class="btn btn--primary btn--full">Proceed to Checkout</button>
      </div>
    </form>
  {% endif %}
</section>
<script>
(function(){
  const form = document.querySelector('.cart__form');
  if(!form) return;
  form.addEventListener('click', function(e){
    if(!e.target.classList.contains('qty-btn')) return;
    const input = e.target.parentElement.querySelector('.qty');
    const change = parseInt(e.target.dataset.change, 10);
    const newVal = Math.max(0, parseInt(input.value, 10) + change);
    input.value = newVal;
    input.dispatchEvent(new Event('change'));
  });
  form.addEventListener('change', function(e){
    if(!e.target.classList.contains('qty')) return;
    const body = new FormData(form);
    fetch('/cart/update.js', { method:'POST', body })
      .then(r=>r.json())
      .then(cart=>{
        document.getElementById('CartSubtotal').textContent = Shopify.formatMoney(cart.total_price);
        cart.items.forEach((item, index)=>{
          const line = document.querySelector(`tr[data-line="${index+1}"] .cart__subtotal`);
          if(line) line.textContent = Shopify.formatMoney(item.line_price);
        });
        const countEl = document.querySelector('.ysa-cart-count');
        if(countEl) countEl.textContent = cart.item_count;
      });
  });
})();
</script>

